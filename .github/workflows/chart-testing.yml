name: chart-testing

on: [push, pull_request]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
    - uses: pre-commit/action@v2.0.0


  catalog-tests:
    runs-on: ubuntu-latest
    container:
      image: ixsystems/catalog_validation:latest

    steps:
    - uses: actions/checkout@v1
      name: Checkout
    - name: Validate catalog format
      run: |
        /bin/bash -c "PWD=${pwd}; /usr/local/bin/catalog_validate validate --path $PWD"


  chart-tests:
    needs: pre-commit
    runs-on: ubuntu-20.04

    steps:
      - name: Install Helm
        run: /bin/bash -c "curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash"

      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Fetch base branch history
        run: git fetch origin master:master

      - name: Setup catalog validation
        run: |
          sudo apt update > /dev/null 2>&1
          sudo apt install -y python3-all-dev python3-pip python3-setuptools > /dev/null 2>&1
          git clone https://github.com/truecharts/catalog_validation
          sudo pip3 install --disable-pip-version-check --exists-action w -r catalog_validation/requirements.txt > /dev/null 2>&1
          sudo pip3 install -U catalog_validation/.

      - name: Validate changed charts
        run: /bin/bash -c "PWD=${pwd}; sudo /usr/local/bin/charts_validate deploy --path $PWD"
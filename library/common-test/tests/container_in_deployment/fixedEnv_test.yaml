suite: container in deployment fixed env test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment

  - it: should pass with injectFixedEnvs false
    documentIndex: *deploymentDoc
    set:
      injectFixedEnvs: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].env

  - it: should pass with TZ and UMASK changed
    documentIndex: *deploymentDoc
    set:
      TZ: ETC
      security:
        UMASK: 3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: ETC
            - name: UMASK
              value: "3"
            - name: UMASK_SET
              value: "3"
            - name: NVIDIA_VISIBLE_DEVICES
              value: void
            - name: S6_READ_ONLY_ROOT
              value: "1"

  - it: should pass without S6_READ_ONLY_ROOT
    documentIndex: *deploymentDoc
    set:
      securityContext:
        readOnlyRootFilesystem: false
        runAsNonRoot: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: UTC
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_VISIBLE_DEVICES
              value: void

  - it: should pass with scaleGPU set
    documentIndex: *deploymentDoc
    set:
      scaleGPU:
        gpu.intel.com/i915: "1"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: UTC
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_DRIVER_CAPABILITIES
              value: all
            - name: S6_READ_ONLY_ROOT
              value: "1"

  - it: should pass with envs changed because run as user root
    documentIndex: *deploymentDoc
    set:
      podSecurityContext:
        runAsUser: 0
      securityContext:
        runAsNonRoot: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: UTC
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_VISIBLE_DEVICES
              value: void
            - name: PUID
              value: "568"
            - name: USER_ID
              value: "568"
            - name: UID
              value: "568"
            - name: PGID
              value: "568"
            - name: GROUP_ID
              value: "568"
            - name: GID
              value: "568"
            - name: S6_READ_ONLY_ROOT
              value: "1"

  - it: should pass with envs changed because run as group root
    documentIndex: *deploymentDoc
    set:
      podSecurityContext:
        runAsGroup: 0
      securityContext:
        runAsNonRoot: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: UTC
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_VISIBLE_DEVICES
              value: void
            - name: PUID
              value: "568"
            - name: USER_ID
              value: "568"
            - name: UID
              value: "568"
            - name: PGID
              value: "568"
            - name: GROUP_ID
              value: "568"
            - name: GID
              value: "568"
            - name: S6_READ_ONLY_ROOT
              value: "1"

  - it: should pass with envs changed because run as user root and PUID 0
    documentIndex: *deploymentDoc
    set:
      podSecurityContext:
        runAsUser: 0
      securityContext:
        runAsNonRoot: false
      security:
        PUID: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: UTC
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_VISIBLE_DEVICES
              value: void
            - name: PUID
              value: "0"
            - name: USER_ID
              value: "0"
            - name: UID
              value: "0"
            - name: PGID
              value: "568"
            - name: GROUP_ID
              value: "568"
            - name: GID
              value: "568"
            - name: S6_READ_ONLY_ROOT
              value: "1"

  - it: should pass with envs changed because run as group root and PUID 0
    documentIndex: *deploymentDoc
    set:
      podSecurityContext:
        runAsGroup: 0
      securityContext:
        runAsNonRoot: false
      security:
        PUID: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: UTC
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_VISIBLE_DEVICES
              value: void
            - name: PUID
              value: "0"
            - name: USER_ID
              value: "0"
            - name: UID
              value: "0"
            - name: PGID
              value: "568"
            - name: GROUP_ID
              value: "568"
            - name: GID
              value: "568"
            - name: S6_READ_ONLY_ROOT
              value: "1"

  - it: should pass with envs changed because run as group root and fsGroup 0 and PUID 0
    documentIndex: *deploymentDoc
    set:
      podSecurityContext:
        runAsGroup: 0
        fsGroup: 0
      securityContext:
        runAsNonRoot: false
      security:
        PUID: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: UTC
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_VISIBLE_DEVICES
              value: void
            - name: PUID
              value: "0"
            - name: USER_ID
              value: "0"
            - name: UID
              value: "0"
            - name: PGID
              value: "0"
            - name: GROUP_ID
              value: "0"
            - name: GID
              value: "0"
            - name: S6_READ_ONLY_ROOT
              value: "1"


  - it: should pass with envs defined with scaleGPU
    documentIndex: *deploymentDoc
    set:
      scaleGPU:
        gpu.intel.com/i915: "1"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: "UTC"
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_DRIVER_CAPABILITIES
              value: "all"
            - name: S6_READ_ONLY_ROOT
              value: "1"

  - it: should pass with envs defined with scaleGPU and custom capabilities
    documentIndex: *deploymentDoc
    set:
      scaleGPU:
        gpu.intel.com/i915: "1"
      nvidiaCaps:
        - compute
        - utility
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env
          value:
            - name: TZ
              value: "UTC"
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: NVIDIA_DRIVER_CAPABILITIES
              value: "compute,utility"
            - name: S6_READ_ONLY_ROOT
              value: "1"
